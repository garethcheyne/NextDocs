# Development Dockerfile with hot reload
FROM node:20-alpine

WORKDIR /app

# Install dependencies for node-gyp and curl for worker initialization
RUN apk add --no-cache python3 make g++ curl

# Copy package files
COPY package.json package-lock.json* ./

# Install dependencies
RUN npm install

# Copy Prisma schema
COPY prisma ./prisma

# Generate Prisma Client
RUN npx prisma generate

# Copy the entire project for development
COPY . .

# Expose development port
EXPOSE 8100

# Set environment variables
ENV PORT=8100
ENV HOSTNAME="0.0.0.0"
ENV NEXT_TELEMETRY_DISABLED=1

# Ensure scripts directory exists and init script is executable
RUN mkdir -p /app/scripts && \
    if [ -f /app/scripts/init-worker.sh ]; then chmod +x /app/scripts/init-worker.sh; fi

# Install any missing packages on startup (in case package.json changed)
# Run migrations, then start development server with hot reload and worker in background
CMD sh -c "npm install && npx prisma migrate deploy && npx next dev & sleep 10 && if [ -f /app/scripts/init-worker.sh ]; then /app/scripts/init-worker.sh; fi && wait"
